version: 1
applications:
  - appRoot: 01_app
    frontend:
      phases:
        preBuild:
          commands:
            - node --version
            - npm --version
            - npm ci --prefer-offline --no-audit --no-fund
        build:
          commands:
            # 1) Generate amplify_outputs.json with fixed User Pool FIRST
            - echo "Generating amplify_outputs.json with fixed User Pool"
            - |
              # Create amplify_outputs.json with fixed centra-weather-userpool-CentraV2
              echo '{
                "auth": {
                  "user_pool_id": "ap-northeast-1_0hkVfrsxW",
                  "aws_region": "ap-northeast-1",
                  "user_pool_client_id": "4ui2d4ju3gb8hc7eo7drfbesfq",
                  "identity_pool_id": "ap-northeast-1:9325a861-9a3f-4684-8240-663790b26cd7",
                  "mfa_methods": [],
                  "standard_required_attributes": ["email"],
                  "username_attributes": ["email"],
                  "user_verification_types": ["email"],
                  "groups": [],
                  "mfa_configuration": "NONE",
                  "password_policy": {
                    "min_length": 8,
                    "require_lowercase": true,
                    "require_numbers": true,
                    "require_symbols": true,
                    "require_uppercase": true
                  },
                  "unauthenticated_identities_enabled": true,
                  "sign_up_verification_method": "code",
                  "user_pool_name": "centra-weather-userpool-CentraV2"
                },
                "data": {
                  "url": "https://dxmu7e3xjjg7nkg3ze2vvoxtcm.appsync-api.ap-northeast-1.amazonaws.com/graphql",
                  "aws_region": "ap-northeast-1",
                  "default_authorization_type": "AMAZON_COGNITO_USER_POOLS",
                  "authorization_types": ["AMAZON_COGNITO_USER_POOLS", "AWS_IAM"]
                },
                "custom": {
                  "awsRegion": {
                    "value": "ap-northeast-1",
                    "description": "AWS Region"
                  },
                  "logbookToSheetsUrl": "https://q6lncgrt3vz4uqt4l323ug6fqm0xjydg.lambda-url.ap-northeast-1.on.aws/",
                  "parentFolderId": {
                    "value": "",
                    "description": "Google Drive parent folder ID for frontend-created workbooks"
                  }
                },
                "version": "1.4"
              }' > amplify_outputs.json
              echo "Generated amplify_outputs.json with fixed User Pool:"
              cat amplify_outputs.json | head -20
              echo "File size: $(wc -c < amplify_outputs.json) bytes"
            - cp amplify_outputs.json public/amplify_outputs.json
            # 2) Deploy Amplify Gen2 backend for this app/branch
            - echo "Deploying Amplify Gen2 backend (pipeline-deploy)"
            - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID --debug
            # 3) Build frontend
            - echo "Building frontend"
            - npm run build
            - ls -la build
      artifacts:
        baseDirectory: build
        files:
          - "**/*"
      cache:
        paths:
          - node_modules/**/*
          - .npm/**/*
