# 気象センサー統合システム 実装タスク

## 実装計画

以下のタスクは、気象センサーから Web アプリケーションまでのシームレスな統合を実現するための段階的な実装計画です。各タスクは前のタスクの成果物を基に構築され、テスト駆動開発により品質を確保します。

- [ ] 1. バックエンドインフラストラクチャの構築

  - AWS Amplify Gen2 環境での IoT Core、DynamoDB、AppSync の基盤設定
  - 既存の Centra アプリケーションとの統合準備
  - _要件: 1.1, 1.4, 3.1, 5.1, 5.3_

- [ ] 1.1 DynamoDB テーブル設計と作成

  - CentraSensorData テーブルの単一テーブル設計実装
  - パーティションキー（PK）とソートキー（SK）の設定
  - TTL 属性の設定（生データ: 1 時間、統計データ: 24 時間）
  - GSI（Global Secondary Index）の作成
  - _要件: 3.1, 3.2, 3.3, 3.5_

- [ ] 1.2 IoT Core 設定とセキュリティ

  - IoT Thing Type の定義（MadoSensorDevice）
  - X.509 証明書による相互認証設定
  - IoT Policy の作成と権限設定
  - MQTT トピック構造の定義（mado/centra/+/telemetry）
  - _要件: 1.1, 5.2, 5.3_

- [ ] 1.3 IoT Rule と Lambda 統合

  - IoT Rule による MQTT メッセージの Lambda 関数への転送設定
  - エラーハンドリング用 CloudWatch Logs の設定
  - Lambda 関数の実行権限設定
  - _要件: 1.2, 2.1_

- [ ] 2. Lambda 関数：IoT データプロセッサーの実装

  - センサーデータの受信、バリデーション、変換、保存機能
  - リアルタイム配信と統計計算の実装
  - _要件: 1.2, 1.5, 2.1, 2.5, 3.6_

- [ ] 2.1 データバリデーションとエラーハンドリング

  - IoT イベントからのセンサーデータ抽出機能
  - 数値範囲バリデーション（温度: -50~60℃、湿度: 0~100%等）
  - 不正データのスキップとエラーログ記録
  - 構造化ログ出力の実装
  - _要件: 1.5, 7.4_

- [ ] 2.2 DynamoDB 生データ保存機能

  - MadoSensorData から DynamoDBRecord への変換
  - TTL 設定による自動削除（1 時間後）
  - スロットリング対応のリトライ機構
  - パフォーマンス最適化（バッチ処理対応）
  - _要件: 3.1, 3.4, 6.3_

- [ ] 2.3 統計データ計算エンジン

  - 直近 10 分間の生データ取得機能
  - 各気象要素の最大・最小・平均値計算
  - 風向の円形統計処理
  - 電源投入後即座に開始するローリング統計
  - _要件: 3.6, 6.1_

- [ ] 2.4 統計データ保存とライフサイクル管理

  - 統計データの DynamoDB 保存機能
  - TTL 設定による自動削除（24 時間後）
  - 最大瞬間風速の特別ログ出力
  - 統計期間の管理（10 分単位の丸め処理）
  - _要件: 3.2, 3.3, 7.4_

- [ ] 3. AppSync GraphQL API の実装

  - リアルタイムデータ配信とクエリ機能の実装
  - 型安全なスキーマ定義とリゾルバー作成
  - _要件: 2.2, 4.1, 4.2, 4.4_

- [ ] 3.1 GraphQL スキーマ定義

  - SensorData、SensorStats 型の定義
  - Query、Mutation、Subscription 操作の定義
  - 入力型と Enum 型の定義
  - 後方互換性を考慮したスキーマ設計
  - _要件: 4.1, 4.5_

- [ ] 3.2 DynamoDB リゾルバーの実装

  - getCurrentSensorData クエリリゾルバー
  - getRecentSensorData クエリリゾルバー（ページネーション対応）
  - getSensorStats クエリリゾルバー
  - VTL テンプレートの最適化
  - _要件: 4.3, 6.1_

- [ ] 3.3 リアルタイム配信機能

  - publishSensorData ミューテーション
  - onSensorDataUpdate サブスクリプション
  - WebSocket 接続管理
  - 複数クライアント対応
  - _要件: 2.1, 2.4_

- [ ] 3.4 セキュリティとレート制限

  - Cognito User Pool 認証の統合
  - GraphQL Depth Limit の設定
  - レート制限と DoS 攻撃防止
  - 認証トークンの自動リフレッシュ
  - _要件: 5.1, 5.4, 4.4, 7.3_

- [ ] 4. フロントエンド：Weather API Service の実装

  - AppSync クライアントの管理とデータアクセス層
  - エラーハンドリングと再接続機構
  - _要件: 2.3, 2.5, 6.1, 6.5_

- [ ] 4.1 AppSync クライアント設定

  - GraphQL クライアントの初期化
  - Cognito 認証の統合
  - 環境変数による設定管理
  - TypeScript 型定義の生成
  - _要件: 5.1, 5.4_

- [ ] 4.2 データアクセスメソッド

  - getCurrentData メソッド（最新データ取得）
  - getHistoricalData メソッド（履歴データ取得）
  - getStatistics メソッド（統計データ取得）
  - エラーハンドリングとタイムアウト処理
  - _要件: 6.1, 6.5_

- [ ] 4.3 リアルタイム更新の購読管理

  - subscribeToUpdates メソッド
  - WebSocket 接続状態の監視
  - 指数バックオフによる自動再接続
  - メモリリーク防止のためのクリーンアップ
  - _要件: 2.3, 2.5_

- [ ] 5. React Hooks：useWeatherData の実装

  - 状態管理とライフサイクル管理
  - リアルタイム更新とエラーハンドリング
  - _要件: 2.1, 2.3, 6.5_

- [ ] 5.1 状態管理とデータフェッチング

  - currentData、historicalData、statistics 状態の管理
  - 初期データ読み込みロジック
  - ローディング状態とエラー状態の管理
  - 接続状態の監視
  - _要件: 2.1, 6.5_

- [ ] 5.2 リアルタイム更新の統合

  - サブスクリプションの購読と解除
  - 新しいデータの状態への反映
  - 履歴データの自動更新（1 時間以内のデータ保持）
  - 接続状態の更新
  - _要件: 2.1, 2.4_

- [ ] 5.3 エラーハンドリングと再試行機構

  - ネットワークエラーの検出と処理
  - 自動再試行機能（retry 関数）
  - エラー状態の管理とユーザー通知
  - フォールバック機能
  - _要件: 2.3, 2.5, 6.5_

- [ ] 6. UI コンポーネント：リアルタイム表示の実装

  - 気象データのリアルタイム表示コンポーネント
  - レスポンシブデザインとアクセシビリティ対応
  - _要件: 2.1, 2.4_

- [ ] 6.1 RealtimeWeatherCard コンポーネント

  - 現在の気象データの表示
  - 接続状態インジケーター
  - Material-UI によるレスポンシブデザイン
  - ローディング状態とエラー状態の表示
  - _要件: 2.1, 2.4_

- [ ] 6.2 WeatherMetric コンポーネント

  - 個別気象要素の表示コンポーネント
  - アイコンと数値の統一デザイン
  - 単位表示とフォーマット処理
  - アニメーション効果
  - _要件: 2.1_

- [ ] 6.3 ConnectionStatusIndicator コンポーネント

  - WebSocket 接続状態の視覚的表示
  - 接続中、切断中、再接続中の状態表示
  - 最終更新時刻の表示
  - ユーザーフレンドリーなメッセージ
  - _要件: 2.3, 2.5_

- [ ] 7. UI コンポーネント：履歴チャートの実装

  - 時系列データの可視化コンポーネント
  - インタラクティブなチャート機能
  - _要件: 2.1, 6.1_

- [ ] 7.1 WeatherHistoryChart コンポーネント

  - ApexCharts による時系列チャート
  - 複数の気象要素対応
  - ズーム・パン機能
  - レスポンシブ対応
  - _要件: 6.1_

- [ ] 7.2 チャートデータ処理

  - 履歴データのチャート用データ変換
  - 欠損データの処理
  - 時間軸の自動調整
  - パフォーマンス最適化
  - _要件: 6.1_

- [ ] 7.3 チャート設定とカスタマイゼーション

  - 気象要素別の色設定
  - 軸ラベルと単位の表示
  - ツールチップのカスタマイズ
  - テーマ対応（ライト・ダークモード）
  - _要件: 6.1_

- [ ] 8. UI コンポーネント：統計パネルの実装

  - 統計データの表示コンポーネント
  - 最大瞬間風速のハイライト表示
  - _要件: 2.1, 6.1_

- [ ] 8.1 WeatherStatsPanel コンポーネント

  - 10 分間統計データの表示
  - 最大・最小・平均値の表示
  - サンプル数の表示
  - 統計期間の表示
  - _要件: 6.1_

- [ ] 8.2 統計データの視覚化

  - 最大瞬間風速の特別表示
  - 統計値の比較表示
  - トレンド表示
  - アラート表示（閾値超過時）
  - _要件: 6.1_

- [ ] 9. 型定義とユーティリティの実装

  - TypeScript 型定義の整備
  - 共通ユーティリティ関数の実装
  - _要件: 4.1, 4.5_

- [ ] 9.1 TypeScript 型定義

  - SensorData、SensorStats インターフェース
  - WeatherDataType、StatsPeriod 列挙型
  - ConnectionStatus インターフェース
  - GraphQL 生成型との統合
  - _要件: 4.1, 4.5_

- [ ] 9.2 ユーティリティ関数

  - 気象データのフォーマット関数
  - 単位変換関数
  - バリデーション関数
  - 日時処理関数
  - _要件: 1.5_

- [ ] 10. テストスイートの実装

  - 包括的なテストカバレッジの確保
  - 単体テスト、統合テスト、E2E テストの実装
  - _要件: 6.1, 6.5, 8.1_

- [ ] 10.1 Lambda 関数の単体テスト

  - データバリデーション機能のテスト
  - DynamoDB 保存機能のテスト
  - 統計計算機能のテスト
  - エラーハンドリングのテスト
  - _要件: 1.5, 3.6, 6.5_

- [ ] 10.2 React Hooks の単体テスト

  - useWeatherData フックのテスト
  - 状態管理のテスト
  - リアルタイム更新のテスト
  - エラーハンドリングのテスト
  - _要件: 2.1, 2.3, 6.5_

- [ ] 10.3 UI コンポーネントのテスト

  - React Testing Library によるコンポーネントテスト
  - ユーザーインタラクションのテスト
  - アクセシビリティテスト
  - レスポンシブデザインのテスト
  - _要件: 2.1, 2.4_

- [ ] 10.4 統合テストと E2E テスト

  - AppSync API の統合テスト
  - WebSocket 接続のテスト
  - Cypress によるエンドツーエンドテスト（既存 IoT センサーからの実データを使用）
  - パフォーマンステスト
  - _要件: 6.1, 6.2, 2.1_

- [ ] 11. 監視・運用機能の実装

  - CloudWatch メトリクスとアラームの設定
  - ログ管理とトレーシングの実装
  - _要件: 7.1, 7.2, 7.4_

- [ ] 11.1 CloudWatch メトリクス

  - カスタムメトリクスの送信機能
  - 処理遅延時間の監視
  - エラー率の監視
  - 接続数の監視
  - _要件: 7.1, 7.4_

- [ ] 11.2 アラーム設定

  - Lambda 関数エラー率アラーム
  - 処理遅延アラーム
  - DynamoDB スロットリングアラーム
  - コストアラーム
  - _要件: 7.1, 7.2_

- [ ] 11.3 ログ管理とトレーシング

  - 構造化ログの実装
  - X-Ray 分散トレーシング
  - ログ集約とクエリ機能
  - セキュリティログの記録
  - _要件: 7.4, 5.5_

- [ ] 12. デプロイメントと CI/CD の設定

  - 自動化されたデプロイメントパイプライン
  - 環境管理とコンフィギュレーション
  - _要件: 8.1, 8.2, 8.3_

- [ ] 12.1 GitHub Actions ワークフロー

  - テスト自動実行の設定
  - ステージング環境への自動デプロイ
  - 本番環境へのブルーグリーンデプロイ
  - ロールバック機能
  - _要件: 8.1, 8.2, 8.3_

- [ ] 12.2 環境設定管理

  - 開発・ステージング・本番環境の分離
  - 環境変数の管理
  - シークレット管理
  - 設定の検証機能
  - _要件: 8.4_

- [ ] 12.3 インフラストラクチャコード

  - AWS CDK によるインフラ定義
  - 環境別リソース設定
  - コスト最適化設定
  - セキュリティ設定の標準化
  - _要件: 8.4, 7.2_

- [ ] 13. 統合テストとシステム検証

  - エンドツーエンドの動作確認
  - パフォーマンス検証とチューニング
  - _要件: 6.1, 6.2, 6.3, 6.4_

- [ ] 13.1 システム統合テスト

  - 既存 IoT センサーから Web アプリまでの全体フロー検証
  - リアルタイム性能の検証（500ms 以内）
  - 同時接続テスト（最大 50 接続）
  - 負荷テスト（1 秒間 100 書き込み、200 読み取り）
  - _要件: 6.1, 6.2, 3.4, 3.5_

- [ ] 13.2 パフォーマンスチューニング

  - DynamoDB クエリの最適化
  - Lambda 関数のコールドスタート対策
  - フロントエンドのレンダリング最適化
  - メモリ使用量の最適化
  - _要件: 6.1, 6.4_

- [ ] 13.3 セキュリティ検証

  - 認証・認可機能の検証
  - データ暗号化の確認
  - 脆弱性スキャン
  - ペネトレーションテスト
  - _要件: 5.1, 5.2, 5.3, 5.5_

- [ ] 14. ドキュメント作成と運用準備

  - 運用マニュアルとトラブルシューティングガイド
  - API 仕様書とユーザーガイド
  - _要件: 8.4_

- [ ] 14.1 技術ドキュメント

  - API 仕様書の作成
  - アーキテクチャドキュメント
  - データベース設計書
  - セキュリティガイドライン
  - _要件: 4.1, 5.3_

- [ ] 14.2 運用ドキュメント

  - 運用マニュアル
  - トラブルシューティングガイド
  - 監視ダッシュボードの説明
  - 緊急時対応手順
  - _要件: 7.1, 7.4_

- [ ] 14.3 ユーザーガイド
  - 気象ダッシュボードの使用方法
  - データの見方と解釈
  - トラブル時の対処法
  - FAQ
  - _要件: 2.1, 2.4_
