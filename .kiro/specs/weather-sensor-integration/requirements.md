# 気象センサー統合システム 要件書

## 概要

AWS Amplify Gen2 環境において、気象センサー（Mado M-X）から Web アプリケーションまでのシームレスなデータ連携を実現するシステム。AWS IoT Core、AppSync、DynamoDB を活用したサーバーレスアーキテクチャにより、リアルタイム性、スケーラビリティ、コスト効率を両立する。

## 要件

### 要件 1: センサーデータ収集と IoT 統合

**ユーザーストーリー:** システム管理者として、複数の気象センサーからのデータを確実に収集したいので、IoT Core を通じた安定したデータ取得機能が必要である。

#### 受け入れ基準

1. WHEN Mado センサー（M-X）が MQTT でデータを送信する THEN IoT Core は 100%の確率でメッセージを受信する SHALL
2. WHEN センサーデータが受信される THEN システムは 1 秒以内にデータ処理を開始する SHALL
3. WHEN ネットワーク障害が発生する THEN センサーは自動的に再接続を試行する SHALL
4. WHEN 複数センサーが同時送信する THEN システムは最大 10 台のセンサーを並行処理する SHALL
5. WHEN データ形式が不正な場合 THEN システムはエラーログを記録し、処理を継続する SHALL

### 要件 2: リアルタイムデータ配信

**ユーザーストーリー:** ドローンオペレーターとして、最新の気象状況を即座に把握したいので、遅延の少ないリアルタイムデータ配信が必要である。

#### 受け入れ基準

1. WHEN センサーデータが IoT Core に到着する THEN 500ms 以内に Web アプリに配信される SHALL
2. WHEN Web アプリが起動する THEN AppSync Subscription が自動的に確立される SHALL
3. WHEN WebSocket 接続が切断される THEN システムは 3 秒以内に自動再接続する SHALL
4. WHEN 同時に 5 つのクライアントが接続する THEN 全てのクライアントが同じデータを受信する SHALL
5. WHEN データ配信が失敗する THEN システムは指数バックオフでリトライする SHALL

### 要件 3: データ永続化とライフサイクル管理

**ユーザーストーリー:** データアナリストとして、過去のデータを分析したいが、ストレージコストを抑制したいので、効率的なデータ保持戦略が必要である。

#### 受け入れ基準

1. WHEN センサーデータが受信される THEN DynamoDB に構造化されたデータとして保存される SHALL
2. WHEN 生データが 1 時間経過する THEN TTL により自動削除される SHALL
3. WHEN 統計データが 24 時間経過する THEN TTL により自動削除される SHALL
4. WHEN データ書き込みが発生する THEN 1 秒あたり最大 100 件の書き込みを処理する SHALL
5. WHEN データ読み取りが発生する THEN 1 秒あたり最大 200 件の読み取りを処理する SHALL
6. WHEN 最初のセンサーデータが受信される THEN システムは即座に統計計算を開始し、直近データから 10 分間のローリング統計を計算する SHALL

### 要件 4: GraphQL API 設計とスキーマ管理

**ユーザーストーリー:** フロントエンド開発者として、型安全で効率的なデータアクセスを行いたいので、明確に定義された GraphQL API が必要である。

#### 受け入れ基準

1. WHEN GraphQL クエリが実行される THEN 型安全なレスポンスが返される SHALL
2. WHEN リアルタイムデータが必要な場合 THEN Subscription を使用してデータを配信する SHALL
3. WHEN 履歴データが要求される THEN ページネーション対応のクエリを提供する SHALL
4. WHEN API 呼び出しが発生する THEN Depth Limit により悪意のあるクエリを防ぐ SHALL
5. WHEN スキーマが更新される THEN 後方互換性を維持する SHALL

### 要件 5: 認証・認可とセキュリティ

**ユーザーストーリー:** セキュリティ管理者として、不正アクセスを防ぎながら、正当なユーザーには円滑なアクセスを提供したいので、堅牢な認証システムが必要である。

#### 受け入れ基準

1. WHEN ユーザーが API にアクセスする THEN Cognito JWT トークンによる認証が必要である SHALL
2. WHEN IoT デバイスが通信する THEN X.509 証明書による相互認証を行う SHALL
3. WHEN データ通信が発生する THEN 全ての通信が TLS 1.2 以上で暗号化される SHALL
4. WHEN 認証トークンが期限切れになる THEN 自動的にリフレッシュされる SHALL
5. WHEN 不正なアクセスが検出される THEN CloudTrail にログが記録される SHALL

### 要件 6: パフォーマンスとスケーラビリティ

**ユーザーストーリー:** システムアーキテクトとして、将来の拡張に対応できる高性能なシステムを構築したいので、明確なパフォーマンス基準が必要である。

#### 受け入れ基準

1. WHEN API リクエストが発行される THEN 95%のリクエストが 200ms 以内に応答する SHALL
2. WHEN 同時接続数が増加する THEN 最大 50 の同時 WebSocket 接続を処理する SHALL
3. WHEN データ量が増加する THEN DynamoDB の自動スケーリングが機能する SHALL
4. WHEN Lambda 関数が実行される THEN コールドスタート時間が 1 秒以内である SHALL
5. WHEN システム負荷が高い場合 THEN 適切なエラーハンドリングとフォールバックを提供する SHALL

### 要件 7: 監視・運用とコスト管理

**ユーザーストーリー:** 運用エンジニアとして、システムの健全性を監視し、コストを最適化したいので、包括的な監視とアラート機能が必要である。

#### 受け入れ基準

1. WHEN システムエラーが発生する THEN CloudWatch アラームが 5 分以内に通知する SHALL
2. WHEN 月次コストが$20 を超える THEN コストアラートが発生する SHALL
3. WHEN API 呼び出し数が異常に増加する THEN 自動的にレート制限が適用される SHALL
4. WHEN データ処理遅延が発生する THEN X-Ray トレーシングで原因を特定できる SHALL
5. WHEN システムメトリクスが閾値を超える THEN 自動的にスケールアウトする SHALL

### 要件 8: 開発・デプロイメント効率化

**ユーザーストーリー:** DevOps エンジニアとして、迅速で安全なデプロイメントを実現したいので、自動化された CI/CD パイプラインが必要である。

#### 受け入れ基準

1. WHEN コードがプッシュされる THEN 自動的にテストが実行される SHALL
2. WHEN テストが成功する THEN ステージング環境に自動デプロイされる SHALL
3. WHEN 本番デプロイが実行される THEN ブルーグリーンデプロイメントが使用される SHALL
4. WHEN インフラ変更が必要な場合 THEN AWS CDK による IaC が適用される SHALL
5. WHEN デプロイが失敗する THEN 自動的にロールバックが実行される SHALL
