# Weather Dashboard 実装タスク

- [x] 1. プロジェクト基盤と TypeScript 型定義の作成

  - 気象データ用の TypeScript 型定義ファイルを作成
  - SensorData、SensorStats、WeatherDataType 等のインターフェースを実装
  - DynamoDBレコード構造とTTL設定の型定義を追加
  - _要件: 7.1, 7.3_

- [x] 2. AppSync GraphQL スキーマとリゾルバーの実装

  - Amplify Gen2のスキーマ定義（resource.ts）を作成
  - CentraSensorDataモデルの定義を実装
  - GSI（Global Secondary Index）の設定を追加
  - 認証・認可設定を実装
  - _要件: 7.3, 7.4_

- [x] 3. DynamoDB テーブル設計と CDK 実装

  - CentraSensorData テーブルの Amplify Gen2 定義を作成
  - パーティションキー（PK）とソートキー（SK）の設計を実装
  - TTL 設定（RAW: 1 時間、STATS: 24 時間）を追加
  - GSI（deviceId-timestamp, deviceId-type）を設定
  - _要件: 7.2, 6.5_

- [x] 4. IoT データ処理 Lambda 関数の実装

  - IoT Core からのデータ受信処理を実装
  - 受信データのバリデーションとエラーハンドリングを追加
  - DynamoDB への生データ保存機能を実装
  - 10分間隔での統計データ計算と保存機能を実装
  - AppSync へのリアルタイム配信機能を実装
  - _要件: 1.1, 1.4, 3.1, 3.2, 7.1_

- [x] 5. Weather API Service の実装

  - AppSync クライアントの設定とラッパー関数を作成
  - getCurrentData、getHistoricalData、getStatistics メソッドを実装
  - WebSocket Subscription 管理機能を実装
  - エラーハンドリングとリトライ機構（指数バックオフ）を追加
  - 認証トークン管理と自動リフレッシュ機能を実装
  - _要件: 1.1, 2.1, 3.1, 1.3_

- [x] 6. useWeatherData カスタムフックの実装

  - 気象データ取得とリアルタイム更新を管理するReactフックを作成
  - 現在データ、履歴データ、統計データの統合管理を実装
  - 自動リトライとエラーハンドリング機能を追加
  - 接続状態管理とポーリング機能を実装
  - _要件: 1.1, 2.1, 3.1, 5.2_

- [x] 7. リアルタイムデータ表示コンポーネントの実装

  - RealtimeWeatherCard コンポーネントを作成
  - WebSocket 接続状態の表示機能を実装
  - データ更新時のアニメーション効果を追加
  - 接続エラー時の自動再接続機能を実装
  - 9つの気象要素の表示とアイコン設定を実装
  - _要件: 1.1, 1.3, 5.2_

- [x] 8. 履歴データグラフコンポーネントの実装

  - WeatherHistoryChart コンポーネントを作成
  - Chart.js を使用した時系列グラフを実装
  - ズーム・パン機能を追加
  - 複数の気象要素（温度、湿度、風速等）の切り替え機能を実装
  - 統計情報表示（最大・最小・平均・データ数）を追加
  - _要件: 2.1, 2.4, 4.4_

- [x] 9. 統計情報パネルコンポーネントの実装

  - WeatherStatsPanel コンポーネントを作成
  - 最大・最小・平均値の表示機能を実装
  - 最大瞬間風速のハイライト表示を追加
  - 10 分ごとの統計データ更新機能を実装
  - _要件: 3.1, 3.2, 3.3_

- [x] 10. メインダッシュボードページの統合実装

  - Weather.tsx ページコンポーネントを完全実装
  - RealtimeWeatherCard、WeatherHistoryChart、WeatherStatsPanel の統合
  - レスポンシブレイアウト（Grid システム）の実装
  - デバイス選択機能とページレベル状態管理を追加
  - _要件: 5.1, 5.3, 4.1_

- [x] 11. レスポンシブデザインとダークモード対応

  - Material-UI の Breakpoints を使用したレスポンシブレイアウトを実装
  - モバイル向けのタッチ操作最適化を追加
  - ダークモードテーマの設定と切り替え機能を実装
  - 適切なタッチターゲットサイズの確保
  - _要件: 4.1, 4.2, 4.3_

- [x] 12. データ永続化とページリロード対応

  - ブラウザの localStorage を使用した履歴データキャッシュを実装
  - ページリロード時のデータ復元機能を追加
  - キャッシュの有効期限管理（1 時間）を実装
  - オフライン時の動作確認とフォールバック表示を追加
  - _要件: 2.2, 2.5_

- [x] 13. パフォーマンス最適化の実装

  - React.memo を使用したコンポーネントの最適化
  - useMemo と useCallback による不要な再レンダリング防止
  - 大量データ表示時の仮想化（react-window）を実装
  - 画像とアセットの遅延読み込みを追加
  - _要件: 6.1, 6.2_

- [x] 14. 単体テストの実装

  - WeatherApiService のテストを Jest で作成
  - 各 React コンポーネントのテストを React Testing Library で実装
  - カスタムフック（useWeatherData）のテストを作成
  - モック（MSW）を使用した API 通信テストを追加
  - _要件: 全要件のテストカバレッジ確保_

- [x] 15. 統合テストと E2E テストの実装

  - AppSync API の統合テストを作成
  - DynamoDB Local を使用したデータベーステストを実装
  - Cypress を使用した E2E テストシナリオを作成
  - リアルタイムデータ更新のテストを追加
  - _要件: 1.1, 2.1, 3.1 の統合テスト_

- [x] 16. セキュリティ機能の実装

  - Cognito 認証の統合とトークン管理を実装
  - GraphQL Depth Limit の設定を追加
  - HTTPS 通信の強制とセキュリティヘッダーを設定
  - 入力データのサニタイゼーション処理を実装
  - _要件: 5.1, 5.3, 5.4_

- [x] 17. 監視とログ機能の実装

  - CloudWatch メトリクスの送信機能を追加
  - アプリケーションエラーのログ記録を実装
  - パフォーマンスメトリクス（レスポンス時間等）の計測を追加
  - ユーザー操作のトラッキング機能を実装
  - _要件: 6.1, 6.2, 6.3_

- [x] 18. デプロイメント設定と CI/CD

  - AWS CDK によるインフラストラクチャのコード化
  - GitHub Actions を使用した CI/CD パイプラインを作成
  - 環境別設定（dev/staging/prod）の管理を実装
  - 自動テスト実行とデプロイメント承認フローを追加
  - _要件: システム全体の自動化_

- [x] 19. 最終統合とシステムテスト
  - 全コンポーネントの統合とエンドツーエンドテストを実行
  - パフォーマンス要件（3 秒以内の初期ロード、100ms 以内の更新）の検証
  - 同時接続数（10 クライアント）の負荷テストを実施
  - 月額コスト$10 以下の確認とコスト最適化を実行
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

## 実センサー統合タスク（2025-01-27追加）

- [x] 20. センサーデータのアプリケーション統合
  - 現在のモックデータから実センサーデータへの切り替え
  - AWS IoT Core → DynamoDB → アプリケーションのデータフロー確立
  - AppSync GraphQLクエリの実装と有効化
  - WebSocket接続によるリアルタイムデータ更新の実装
  - _現状: データはDynamoDBに保存されているが、アプリには届いていない_

- [ ] 21. センサーデータ整形の実装
  - 異常な単位値の変換処理を決定（送信前 or 受信後）
    - 温度: 1000.7 → 100.07℃（10で割る）
    - 風速: 615.4 → 61.54 m/s（10で割る）  
    - 風向: 5837 → 77度（360で余りを取る）
    - 体感温度: 999.7 → 適切な値に変換
  - DynamoDBのネストされたdata構造への対応
  - センサー固有の変換ロジックの実装場所を決定
  - _考慮事項: パフォーマンス、保守性、拡張性_

- [ ] 22. データ構造とドキュメントの更新
  - MadoOSのデータ送信フォーマット仕様書の作成
  - IoTトピック構造の統一（dt/mado/+/data vs mado/centra/M-X/telemetry）
  - DynamoDBスキーマドキュメントの更新
  - AppSync GraphQLスキーマの更新と再デプロイ
  - API仕様書の更新（単位、データ型、変換ルール）
  - _影響範囲: MadoOS、IoT Rule、Lambda、アプリケーション_
