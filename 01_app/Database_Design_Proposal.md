# Centrosome データベース設計提案

## 目次
1. [要件整理](#要件整理)
2. [データベース選定](#データベース選定)
3. [DynamoDB設計案](#dynamodb設計案)
4. [代替案の検討](#代替案の検討)
5. [実装ロードマップ](#実装ロードマップ)

## 要件整理

### 現在の要件
- .planファイルの保存・管理
- 機体情報の管理
- フライト履歴の保存

### 将来的な要件
- リアルタイムテレメトリデータの記録
- 複数ユーザー対応
- フライトログの分析
- 共有機能

## データベース選定

### DynamoDBのメリット
✅ **スケーラビリティ**: 自動スケーリングで大量のテレメトリデータに対応
✅ **サーバーレス**: 管理不要、使った分だけ課金
✅ **高速**: ミリ秒レベルのレスポンス
✅ **AWS統合**: S3、Lambda等との連携が簡単

### DynamoDBのデメリット
❌ **クエリの制限**: 複雑なクエリが苦手
❌ **コスト**: 大量のデータ読み書きで高額になる可能性
❌ **学習曲線**: NoSQLの設計パターンを理解する必要

## DynamoDB設計案

### 1. テーブル設計（Single Table Design）

```typescript
// プライマリキー設計
PK (Partition Key): String
SK (Sort Key): String
```

### 2. エンティティ設計

#### ユーザー
```json
{
  "PK": "USER#user123",
  "SK": "PROFILE",
  "email": "pilot@example.com",
  "name": "山田太郎",
  "createdAt": "2024-01-01T00:00:00Z"
}
```

#### 機体情報
```json
{
  "PK": "USER#user123",
  "SK": "AIRCRAFT#aircraft001",
  "callSign": "JA01XX",
  "model": "X8+1 VTOL",
  "manufacturer": "Custom",
  "specs": {
    "maxSpeed": 120,
    "cruiseSpeed": 80,
    "range": 200
  }
}
```

#### フライトプラン
```json
{
  "PK": "USER#user123",
  "SK": "PLAN#2024-01-01#plan001",
  "planName": "福江島周回飛行",
  "aircraft": "aircraft001",
  "waypoints": [...],
  "status": "draft",
  "createdAt": "2024-01-01T10:00:00Z"
}
```

#### フライト記録
```json
{
  "PK": "USER#user123",
  "SK": "FLIGHT#2024-01-01#flight001",
  "planId": "plan001",
  "aircraft": "aircraft001",
  "startTime": "2024-01-01T14:00:00Z",
  "endTime": "2024-01-01T15:30:00Z",
  "distance": 125.5,
  "maxAltitude": 400,
  "status": "completed"
}
```

#### テレメトリデータ（時系列）
```json
{
  "PK": "FLIGHT#flight001",
  "SK": "TELEMETRY#2024-01-01T14:00:01.000Z",
  "lat": 32.7152355,
  "lon": 128.8976253,
  "alt": 150,
  "speed": 25.3,
  "heading": 270,
  "battery": 85
}
```

### 3. グローバルセカンダリインデックス（GSI）

#### GSI1: 日付別フライト検索
- PK: `USER#user123`
- SK: `DATE#2024-01-01`

#### GSI2: 機体別フライト検索
- PK: `AIRCRAFT#aircraft001`
- SK: `FLIGHT#2024-01-01#flight001`

## 代替案の検討

### 1. PostgreSQL + TimescaleDB
**メリット**:
- SQLクエリの柔軟性
- 時系列データに最適化
- 複雑な分析クエリが可能

**デメリット**:
- サーバー管理が必要
- スケーリングが複雑

### 2. MongoDB Atlas
**メリット**:
- 柔軟なドキュメント構造
- 地理空間クエリのサポート
- マネージドサービス

**デメリット**:
- コストが高い
- AWSとの統合が限定的

### 3. ハイブリッドアプローチ（推奨）
```
DynamoDB: メタデータ（ユーザー、機体、フライト情報）
S3: フライトプランファイル、大容量ログ
TimeStream: リアルタイムテレメトリデータ
```

## 実装ロードマップ

### Phase 1: 基本実装（1-2週間）
1. DynamoDBテーブル作成
2. 基本的なCRUD API実装
3. フライトプラン保存機能

### Phase 2: 機体管理（1週間）
1. 機体情報の登録・編集
2. 機体別フライト履歴

### Phase 3: フライト記録（2週間）
1. フライト開始・終了記録
2. 基本的なテレメトリ保存
3. フライト履歴表示

### Phase 4: 高度な機能（3-4週間）
1. TimeStreamとの統合
2. リアルタイムダッシュボード
3. フライトログ分析

## 推奨アーキテクチャ

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Next.js   │────▶│  API Routes │────▶│  DynamoDB   │
│   Frontend  │     │   (tRPC)    │     │   Tables    │
└─────────────┘     └─────────────┘     └─────────────┘
                            │                    │
                            ▼                    ▼
                    ┌─────────────┐     ┌─────────────┐
                    │     S3      │     │ TimeStream  │
                    │   Storage   │     │  (将来)     │
                    └─────────────┘     └─────────────┘
```

## コスト見積もり（月額）

### 小規模利用（〜10ユーザー、〜1000フライト/月）
- DynamoDB: $5-10
- S3: $1-2
- 合計: **$6-12/月**

### 中規模利用（〜100ユーザー、〜10000フライト/月）
- DynamoDB: $20-40
- S3: $5-10
- TimeStream: $50-100
- 合計: **$75-150/月**

## セキュリティ考慮事項

1. **認証・認可**
   - AWS Cognitoでユーザー認証
   - IAMロールでアクセス制御

2. **データ暗号化**
   - 保存時暗号化（DynamoDB標準）
   - 転送時暗号化（HTTPS）

3. **バックアップ**
   - DynamoDBの自動バックアップ
   - S3のバージョニング

## まとめ

### 推奨構成
1. **メインDB**: DynamoDB（柔軟性とスケーラビリティ）
2. **ファイル保存**: S3（.planファイル等）
3. **時系列データ**: TimeStream（将来的に）

この構成により、現在の要件を満たしつつ、将来の拡張にも対応可能なシステムを構築できます。